harvest:
  name: RDS Instances
  description: Retrieve information about RDS instances including Non-Aurora instances
  unique_identifier_keys: DBInstanceArn

  indexes:
    - keys: DBInstanceIdentifier
    - keys: DBClusterIdentifier
    - keys:
        - Engine
        - EngineVersion
    - keys: Endpoint
    - keys: Logs.LogFileName
    - keys: Logs.LastWritten

  # tasks to collect all instances
  tasks:
    all:
      - aws: &describe_db_instances
          name: Retrieve RDS instances
          description: Retrieve all RDS instances
          command: describe_db_instances
          result_as: instances

      - dataset: &update_tags
          name: Update Tags
          description: Update the tags to use a dict format
          data: var.instances
          stages:
            - convert_list_of_dict_to_dict:
                source_key: TagList
                target_key: Tags
                name_key: Key
                value_key: Value

      - aws: &describe_db_log_files
          name: Retrieve RDS log file descriptors
          command: describe_db_log_files
          arguments:
            DBInstanceIdentifier: item.DBInstanceIdentifier
          include_metadata: false
          iterate: var.instances
          result_dict_to_keys: Logs
          result_as:
            name: log_files
            mode: append
            include:
              DBInstanceIdentifier: item.DBInstanceIdentifier

      - dataset:  &merge_log_files
          name: Merge Log Files
          data: var.instances
          result_as: result
          stages:
            - join:
                data: var.log_files
                left_keys:
                  - DBInstanceIdentifier
                right_keys:
                  - DBInstanceIdentifier

    # tasks to collect a single cluster
    single:
      - <<: *describe_db_instances
        arguments:
          DBInstanceIdentifier: var.identifier

      - <<: *update_tags
      - <<: *describe_db_log_files
      - <<: *merge_log_files
