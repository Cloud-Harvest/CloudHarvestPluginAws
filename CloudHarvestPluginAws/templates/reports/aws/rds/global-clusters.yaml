report:
  name: reports.aws RDS Global Clusters
  description: This report returns information about AWS RDS Global Clusters.

  headers:
    - Account
    - Region
    - Identifier
    - Status
    - Engine
    - EngineVersion
    - FailoverStatus

  tasks:
    - mongo:
        name: Get AWS RDS Proxies
        silo: harvest-core
        collection: aws.rds.global-clusters
        filters: '.*'

        arguments:
          pipeline:
            - "$unwind":
                path: "$GlobalClusterMembers"
                preserveNullAndEmptyArrays: true

            - "$match":
                GlobalClusterMembers.IsWriter:
                  "$in": [ null, True]

            - "$project":
                Account: "$Harvest.Account"
                Region: "$Harvest.Region"
                Identifier: "$GlobalClusterIdentifier"
                Status: 1
                Engine: 1
                EngineVersion: 1
                FailoverStatus: "$FailoverState.Status"
