report:
  name: reports.aws.rds.engines
  description: |
    This report returns information about the RDS engines available in the AWS account. It also includes the unwound
    ValidUpgradeTarget field which indicates what version the left-hand engine can upgrade to.

  headers:
    - Active
    - Account
    - Region
    - Engine
    - Version
    - DBParameterGroupFamily
    - Status
    - TargetEngine
    - TargetVersion
    - AutoUpgrade
    - IsMajorVersionUpgrade
    - ExtendedStart
    - ExtendedEnd

  tasks:
    - mongo:
        name: Get RDS engines
        silo: harvest-core
        collection: aws.rds.engines
        filters: '.*'

        arguments:
          pipeline:
            - $lookup:
                from: "aws.rds.major-engine-versions"
                let:
                  account: "$Harvest.Account"
                  region: "$Harvest.Region"
                  engine: "$Engine"
                  majorEngineVersion: "$MajorEngineVersion"
                pipeline:
                  - $match:
                      $expr:
                        $and:
                          - { $eq: ["$Harvest.Account", "$$account"] }
                          - { $eq: ["$Harvest.Region", "$$region"] }
                          - { $eq: ["$Engine", "$$engine"] }
                          - { $eq: ["$MajorEngineVersion", "$$majorEngineVersion"] }

                  - $unwind:
                      path: "$SupportedEngineLifecycles"
                      preserveNullAndEmptyArrays: false

                  - $match:
                      SupportedEngineLifecycles.LifecycleSupportName: "open-source-rds-extended-support"

                  - $project:
                      ExtendedStart: "$SupportedEngineLifecycles.LifecycleSupportStartDate"
                      ExtendedEnd: "$SupportedEngineLifecycles.LifecycleSupportEndDate"

                as: "MajorEngineVersionDetails"

            - $set:
                MajorEngineVersionDetails:
                  $ifNull:
                    - { $arrayElemAt: ["$MajorEngineVersionDetails", 0] }
                    - null

            - $unwind:
                path: "$ValidUpgradeTarget"
                preserveNullAndEmptyArrays: true

            - $project:
                Active: "$Harvest.Active"
                Account: "$Harvest.Account"
                Region: "$Harvest.Region"
                Engine: "$Engine"
                Version: "$EngineVersion"
                DBParameterGroupFamily: "$DBParameterGroupFamily"
                Status: "$Status"
                TargetEngine: "$ValidUpgradeTarget.Engine"
                TargetVersion: "$ValidUpgradeTarget.EngineVersion"
                AutoUpgrade: "$ValidUpgradeTarget.AutoUpgrade"
                IsMajorVersionUpgrade: "$ValidUpgradeTarget.IsMajorVersionUpgrade"
                ExtendedStart:
                  $dateToString:
                    format: "%Y-%m-%d"
                    date: "$MajorEngineVersionDetails.ExtendedStart"
                ExtendedEnd:
                  $dateToString:
                    format: "%Y-%m-%d"
                    date: "$MajorEngineVersionDetails.ExtendedEnd"
